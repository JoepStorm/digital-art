<!DOCTYPE html>
<html>
<head>
  <title>Physarum Evolution</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #1a1a1a; color: #fff; font-family: system-ui, sans-serif; }
    iframe {
      display: block;
      width: 100%;
      height: calc(100vh - 52px);
      border: none;
    }
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      height: 52px;
      background: #111;
      border-top: 1px solid #333;
    }
    button, .link-btn {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
    }
    button:hover, .link-btn:hover { background: #444; }
    button:disabled { opacity: 0.3; cursor: default; }
    .label {
      font-variant-numeric: tabular-nums;
      min-width: 70px;
      text-align: center;
      font-size: 14px;
      color: #aaa;
    }
    .desc {
      font-size: 13px;
      color: #888;
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    select {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <iframe id="sketch"></iframe>
  <div class="controls">
    <select id="runSelect" onchange="switchRun(this.value)"></select>
    <button onclick="load(0)">&laquo;</button>
    <button id="prev" onclick="go(-1)">&larr;</button>
    <input id="geninput" type="number" min="0" value="0"
      style="width:48px;background:#222;color:#fff;border:1px solid #555;border-radius:4px;padding:4px 6px;font-size:14px;text-align:center;-moz-appearance:textfield"
      onchange="load(Math.max(0,Math.min(manifest.latest,+this.value)))">
    <span class="label" id="label">-</span>
    <button id="next" onclick="go(1)">&rarr;</button>
    <button onclick="load(manifest.latest)">&raquo;</button>
    <span class="desc" id="desc"></span>
    <a class="link-btn" id="galleryLink" href="gallery.html">Gallery</a>
  </div>
  <script src="snapshots/runs.js"></script>
  <script>
    var runsData = window.RUNS || { runs: [], default: 'run_01' };
    var params = new URLSearchParams(window.location.search);
    var currentRun = params.get('run') || runsData.default || 'run_01';
    var manifest = { latest: 0, iterations: [] };
    var current = 0;

    function populateRunSelector() {
      var sel = document.getElementById('runSelect');
      sel.innerHTML = '';
      runsData.runs.forEach(function(r) {
        var opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = (r.name || r.id) + ' (' + r.iterations + ' iters)';
        if (r.id === currentRun) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function switchRun(runId) {
      window.location.href = 'viewer.html?run=' + runId;
    }

    function loadRunManifest(runId, callback) {
      var s = document.createElement('script');
      s.src = 'snapshots/' + runId + '/manifest.js';
      s.onload = callback;
      document.head.appendChild(s);
    }

    function go(delta) {
      load(Math.max(0, Math.min(manifest.latest, current + delta)));
    }

    function load(n) {
      current = n;
      document.getElementById('sketch').src = 'index.html?run=' + currentRun + '&gen=' + n;
      document.getElementById('geninput').value = n;
      document.getElementById('geninput').max = manifest.latest;
      document.getElementById('label').textContent = '/ ' + manifest.latest;
      document.getElementById('prev').disabled = (n <= 0);
      document.getElementById('next').disabled = (n >= manifest.latest);
      var entry = manifest.iterations.find(function(e) { return e.num === n; });
      document.getElementById('desc').textContent = entry ? entry.description : '';
      document.getElementById('galleryLink').href = 'gallery.html?run=' + currentRun;
    }

    populateRunSelector();
    loadRunManifest(currentRun, function() {
      manifest = window.MANIFEST || { latest: 0, iterations: [] };
      var startGen = params.get('gen');
      load(startGen !== null ? Math.max(0, Math.min(manifest.latest, +startGen)) : manifest.latest);
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft') go(-1);
      if (e.key === 'ArrowRight') go(1);
    });
  </script>
</body>
</html>
