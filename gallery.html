<!DOCTYPE html>
<html>
<head>
  <title>Physarum Gallery</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a1a;
      color: #fff;
      font-family: system-ui, sans-serif;
      padding: 24px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 32px;
    }
    .header h1 { font-size: 20px; font-weight: 500; }
    a.btn {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 6px 14px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 14px;
    }
    a.btn:hover { background: #444; }
    select {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 14px;
    }
    .entry {
      margin-bottom: 32px;
    }
    .entry img {
      width: 100%;
      max-width: 1600px;
      border-radius: 4px;
    }
    .entry .meta {
      padding: 8px 0;
      font-size: 14px;
      color: #999;
    }
    .entry .meta strong { color: #ccc; }
    .run-prompt {
      margin-bottom: 32px;
      padding: 16px;
      background: #222;
      border-left: 3px solid #555;
      border-radius: 4px;
      font-size: 14px;
      color: #aaa;
      line-height: 1.5;
    }
    .run-prompt strong { color: #ccc; }
  </style>
</head>
<body>
  <div class="header">
    <a class="btn" id="viewerLink" href="viewer.html">&larr; Viewer</a>
    <h1>Evolution Gallery</h1>
    <select id="runSelect" onchange="switchRun(this.value)"></select>
  </div>
  <div id="runPrompt" class="run-prompt" style="display:none"></div>
  <div id="gallery"></div>
  <script src="snapshots/runs.js"></script>
  <script>
    var runsData = window.RUNS || { runs: [], default: 'run_01' };
    var params = new URLSearchParams(window.location.search);
    var currentRun = params.get('run') || runsData.default || 'run_01';

    function populateRunSelector() {
      var sel = document.getElementById('runSelect');
      sel.innerHTML = '';
      runsData.runs.forEach(function(r) {
        var opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = (r.name || r.id) + ' (' + r.iterations + ' iters)';
        if (r.id === currentRun) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function switchRun(runId) {
      window.location.href = 'gallery.html?run=' + runId;
    }

    function loadRunManifest(runId, callback) {
      var s = document.createElement('script');
      s.src = 'snapshots/' + runId + '/manifest.js';
      s.onload = callback;
      document.head.appendChild(s);
    }

    function renderGallery() {
      var data = window.MANIFEST || { latest: 0, iterations: [] };
      var el = document.getElementById('gallery');
      el.innerHTML = '';
      document.getElementById('viewerLink').href = 'viewer.html?run=' + currentRun;
      var runInfo = runsData.runs.find(function(r) { return r.id === currentRun; });
      var promptEl = document.getElementById('runPrompt');
      if (runInfo && runInfo.prompt && runInfo.prompt !== 'default') {
        promptEl.innerHTML = '<strong>Prompt:</strong> ' + runInfo.prompt;
        promptEl.style.display = '';
      } else {
        promptEl.style.display = 'none';
      }
      for (var i = 0; i <= data.latest; i++) {
        var entry = data.iterations.find(function(e) { return e.num === i; });
        var num = String(i).padStart(4, '0');
        var desc = entry && entry.description ? ' \u2014 ' + entry.description : '';
        var div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML =
          '<div class="meta"><strong>Iteration ' + i + '</strong>' + desc +
          ' <a class="btn" href="viewer.html?run=' + currentRun + '&gen=' + i + '">View &rarr;</a></div>' +
          '<img src="snapshots/' + currentRun + '/' + num + '.png" loading="lazy" alt="Iteration ' + i + '">';
        el.appendChild(div);
      }
    }

    populateRunSelector();
    loadRunManifest(currentRun, function() {
      renderGallery();
    });
  </script>
</body>
</html>
